
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Blog</title>
	<meta name="author" content="Davide Prati">
	<link href='/assets/themes/the-program/css/style.css' rel="stylesheet" media="all">
	<link href='/assets/themes/the-program/css/native.css' rel="stylesheet" media="all">
	<link href="http://feeds.feedburner.com/" rel="alternate" title="Blog" type="application/atom+xml">
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.0.6/modernizr.min.js"></script>
</head>
<body>

<div id="page" class="hentry">
	<header class="the-header">
		<div class="unit-head">
			<div class="unit-inner unit-head-inner">
				<nav class="nav-global">
					<ul>
						<li class="logo"><a href="/">Edapx</a></li>
						<li class="pages"><a href="/about.html">about</a></li>
						<li class="archive"><a href="/archive.html">archive</a></li>
						<li class="tag"><a href="/tags.html">tags</a></li>
						</ul>
				</nav>
			</div><!-- unit-inner -->
		</div><!-- unit-head -->
	</header>
	<div class="body" role="main">
		<div class="unit-body">
			<div class="unit-inner unit-body-inner">
				<div class="entry-content">
					
<article class="unit-article layout-page">
	<div class="unit-inner unit-article-inner">
		<div class="content">
			<header>
				<div class="unit-head">
					<div class="unit-inner unit-head-inner">
						<h1 class="h2 entry-title">Blog</h1>
					</div><!-- unit-inner -->
				</div><!-- unit-head -->
			</header>

			<div class="bd">
				<div class="entry-content">
					

   <!-- here add you post markup -->
   <h1><a href="/2011/12/09/contare-child-rows-per-un-determinato-record">Contare child rows per un determinato record.</a></h1>
   <p class="author">
   <span class="date">09 December 2011</span>
  </p>
  <div class="content">
    Supponiamo il caso di avere un post con relativi articoli, un autore con molti libri, una ditta che ha ricevuto degli ordini, o ancora, un la risposta piu' votata all'interno di un questionario.
In tutti questi casi, per ogni record principale avremo piu' record correlati. Supponiamo il caso di voler contare, nella pagina dove vengono elencate le risposte, quanti voti ogni risposta ha ricevuto, mostrando la piu' votata per prima. In Rails, possiamo scrivere un apposito metodo direttamente nel model.
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Answer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
	<span class="n">belongs_to</span> <span class="ss">:survey</span>
	<span class="n">has_many</span> <span class="ss">:vote</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>	
	
	<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">more_voted</span><span class="p">(</span><span class="n">survey_id</span><span class="p">)</span>
		<span class="n">voted_answer</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span>
			<span class="ss">:all</span><span class="p">,</span> <span class="ss">:select</span> <span class="o">=&gt;</span> <span class="s1">&#39;answers.*, count(votes.id) as vote_count&#39;</span><span class="p">,</span>
			<span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;answers.survey_id = ?&quot;</span><span class="p">,</span> <span class="n">survey_id</span><span class="o">]</span><span class="p">,</span>			
			<span class="ss">:joins</span> <span class="o">=&gt;</span> <span class="s1">&#39;left outer join votes on votes.answer_id = answers.id&#39;</span><span class="p">,</span>
			<span class="ss">:group</span> <span class="o">=&gt;</span> <span class="s1">&#39;answers.id&#39;</span><span class="p">,</span>
			<span class="ss">:Order</span> <span class="o">=&gt;</span> <span class="s1">&#39;vote_count DESC&#39;</span>
		<span class="p">)</span>		
	<span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


Ora nella nostra action 'show' per il controller survey, dove vengono elencate tutte le risposte per il tal survey, possiamo recuperare le answer con il metodo appena creato.
<div class="highlight"><pre><code class="ruby"><span class="vi">@answers</span> <span class="o">=</span> <span class="no">Answer</span><span class="o">.</span><span class="n">more_voted</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:survey_id</span><span class="o">]</span><span class="p">)</span>
</code></pre>
</div>

e mostrare nella view il valore 'vote_count'
<div class="highlight"><pre><code class="ruby"><span class="o">&lt;</span><span class="sx">% @answers.each </span><span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">	&lt;tr class=&quot;even&quot;&gt;</span>
	<span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="sx">%= &quot;</span><span class="si">#{</span><span class="n">a</span><span class="o">.</span><span class="n">reply</span><span class="si">}</span><span class="sx">&quot; %&gt;&lt;/td&gt;</span>
<span class="sx">	&lt;td&gt;&lt;%=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">a</span><span class="o">.</span><span class="n">vote_count</span><span class="si">}</span><span class="s2">&quot;</span> <span class="sx">%&gt; &lt;/td&gt;</span>
	<span class="o">&lt;</span><span class="sr">/tr&gt;</span>
<span class="sr">&lt;% end %&gt;</span>
</code></pre>
</div>

Link consigliati:
<a href="http://therailsway.com/2007/6/1/railsconf-recap-skinny-controllers">http://therailsway.com/2007/6/1/railsconf-recap-skinny-controllers</a>
<a href="http://blog.devinterface.com/2010/06/rails-best-practices-1-fat-model-skinny-controller/">http://blog.devinterface.com/2010/06/rails-best-practices-1-fat-model-skinny-controller/</a>
<a href="http://weblog.jamisbuck.org/2006/10/18/skinny-controller-fat-model">http://weblog.jamisbuck.org/2006/10/18/skinny-controller-fat-model</a>

  </div>


   <!-- here add you post markup -->
   <h1><a href="/2011/12/02/aggiungere-una-action-ad-un-controller-in-rails3">Aggiungere una action ad un controller in rails3</a></h1>
   <p class="author">
   <span class="date">02 December 2011</span>
  </p>
  <div class="content">
    Rails3 cread i default <a href="http://guides.rubyonrails.org/routing.html#crud-verbs-and-actions">sette azioni</a> per ogni controller generato dinamicamente.
Se vogliamo aggiungere un azione, che ne so, per aggiornare un solo valore nel database, per una nuova view, o per quasiasi altra cosa, dobbiamo:
1)Scrivere la nostra azione nel controller, in questo esempio scrivero' un azione per disapprovare un commento, settando a "0" il valore del campo "approved".
<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">disapprove</span>
	<span class="vi">@comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span> <span class="vi">@comment</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:approved</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
		<span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
			<span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">admin_comment_url</span><span class="p">(</span><span class="vi">@comment</span><span class="p">),</span> 
					<span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s1">&#39;Comment was unapproved.&#39;</span><span class="p">)</span> <span class="p">}</span>
			<span class="nb">format</span><span class="o">.</span><span class="n">xml</span>  <span class="p">{</span> <span class="n">head</span><span class="ss">:ok</span> <span class="p">}</span>
		<span class="k">end</span>
	<span class="k">else</span>
		<span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
			<span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s2">&quot;edit&quot;</span> <span class="p">}</span>
			<span class="nb">format</span><span class="o">.</span><span class="n">xml</span>  <span class="p">{</span><span class="n">render</span><span class="ss">:xml</span><span class="o">=&gt;</span><span class="vi">@comment</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="ss">:unprocessable_entity</span> <span class="p">}</span>
		<span class="k">end</span>	
	<span class="k">end</span>		
<span class="k">end</span>
</code></pre>
</div>

Nel mio file routes.rb, dovro' dire alla mia app che oltre alle 7 azioni canoniche ce ne' un altra, disapprove. E dovro' specifivare che tipo di http request e', tra post, get, put e delete. Nel mio caso ho messo post, piu' dettagli <a href="http://guides.rubyonrails.org/routing.html#adding-more-restful-actions">qui</a>
<div class="highlight"><pre><code class="ruby"><span class="n">resources</span> <span class="ss">:comment</span> <span class="k">do</span>
	<span class="n">post</span> <span class="s1">&#39;disapprove&#39;</span><span class="p">,</span><span class="ss">:on</span><span class="o">=&gt;</span><span class="ss">:member</span>
<span class="k">end</span>
</code></pre>
</div>

Lanciando "rake routes" nella cartella della mia app, posso vedere la nuova route creata, e vedere quale e' l'url da utlizzare nell'helper. Nel mio caso l'approvazione dei commenti si trova nell'admin area.
<div class="highlight"><pre><code class="ruby"><span class="n">disapprove_admin_comment</span> <span class="no">POST</span>   <span class="sr">/admin/</span><span class="n">comments</span><span class="o">/</span><span class="ss">:id</span><span class="o">/</span><span class="n">disapprove</span><span class="p">(</span><span class="o">.</span><span class="ss">:format</span><span class="p">)</span>              <span class="p">{</span><span class="ss">:controller</span><span class="o">=&gt;</span><span class="s2">&quot;admin/comments&quot;</span><span class="p">,</span> <span class="ss">:action</span><span class="o">=&gt;</span><span class="s2">&quot;disapprove&quot;</span><span class="p">}</span>
</code></pre>
</div>

Ora creaimo un link all'azione
<div class="highlight"><pre><code class="ruby"><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Disapprove&#39;</span><span class="p">,</span> <span class="n">disapprove_admin_comment_path</span><span class="p">(</span><span class="vi">@comment</span><span class="p">)</span><span class="o">%&gt;</span>
</code></pre>
</div>

Dopo aver generato questo link, ottenevo un errore "No route matches..." la mia azione.
Errore risolto<a href="http://api.rubyonrails.org/classes/ActionView/Helpers/UrlHelper.html#method-i-link_to"> specificando</a> nel link il tipo di http verb
<div class="highlight"><pre><code class="ruby"><span class="o">&lt;</span><span class="sx">%= link_to &#39;Disapprove&#39;, disapprove_admin_comment_path(@comment), :method=</span><span class="o">&gt;</span><span class="s1">&#39;post&#39;</span> <span class="o">%&gt;</span>
</code></pre>
</div>

 
Consiglio questi screencast, per capire come vengono generate le routes, <a href="http://railscasts.com/episodes/231-routing-walkthrough">1</a> e <a href="http://railscasts.com/episodes/232-routing-walkthrough-part-2">2</a>

  </div>


   <!-- here add you post markup -->
   <h1><a href="/2011/11/17/creare-un-admin-area-in-rails3-usando-lautenticazione-scritta-in-devise">Creare un admin area in rails3 usando l'autenticazione scritta in devise</a></h1>
   <p class="author">
   <span class="date">17 November 2011</span>
  </p>
  <div class="content">
    <strong>1)</strong>aggiungere il namespace "admin" in routes.rb, ed abbinarlo ai controller per i quali vogliamo l'autenticazione, in questo esempio "questions".
<div class="highlight"><pre><code class="ruby"><span class="n">namespace</span> <span class="ss">:admin</span> <span class="k">do</span>
	<span class="n">match</span> <span class="s1">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;questions#index&#39;</span>
	<span class="n">resources</span> <span class="ss">:questions</span>
<span class="k">end</span>
</code></pre>
</div>

<strong>2</strong>In views/layout creare il layout admin.html.erb specificando le parti che vogliamo mostrare nella sezione admin.
<strong>3)</strong> creare il controller admin_controller.rb in controllers/admin e utilizzare "autenticate_user" (vedere il tutorial su <a href="/blog/2011/07/24/ruby-on-rails-devise-authentication/">devise</a>) per verificare che un utente sia loggato
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">AdminController</span> <span class="o">::</span> <span class="no">ApplicationController</span>
	<span class="n">layout</span> <span class="s2">&quot;admin&quot;</span>
	<span class="n">before_filter</span> <span class="ss">:authenticate_user!</span>
<span class="k">end</span>
</code></pre>
</div>


<strong>4)</strong> Sempre in controllers/admin, creare il file questions_controller.rb
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">QuestionsController</span> <span class="o">&lt;</span> <span class="no">Admin</span><span class="o">::</span><span class="no">AdminController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@questions</span> <span class="o">=</span> <span class="no">Question</span><span class="o">.</span><span class="n">all</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="c1"># index.html.erb</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<strong>5)</strong>in views/admin creaimo la cartella "questions" e inderiamo tutte le views richieste dal controller controllers/admin/questions_controller.rb, in questo caso, solo il file index.html.rb
<strong>6</strong>
Le action dei form all'interno delle views in views/admin/questions devono rimandare ai controllers in controllers/admin/question controller. Quindi, sempre tenendo "question" come esempio da:
<div class="highlight"><pre><code class="ruby"><span class="o">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@answer</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="o">%&gt;</span>
</code></pre>
</div>

dobbiamo passare a 
<div class="highlight"><pre><code class="ruby"><span class="o">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:admin</span><span class="p">,</span> <span class="vi">@answer</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="o">%&gt;</span>
</code></pre>
</div>


  </div>


<!-- Pagination links -->
<div class="pagination">
  
    <a href="/page2" class="previous">Previous</a>
  
  <span class="page_number ">Page: 3 of 16</span>
  
    <a href="/page4" class="next ">Next</a>
  
</div>

				</div><!-- entry-content -->
			</div><!-- bd -->

			<footer class="unit-foot">
				<div class="unit-inner unit-foot-inner">
					<p class="gotop">
						<a href="#page">Back to Top</a>
					</p>
				</div>
			</footer>

		</div><!-- content -->
	</div><!-- unit-inner -->
</article>


				</div>
			</div><!-- unit-inner -->
		</div><!-- unit-body -->
	</div><!-- body -->
	<footer class="the-footer">
		<div class="unit-foot">
			<div class="unit-inner unit-foot-inner">
				<div class="misc vcard">
					<h4>contact</h4>
					<ul>
						<li class="contact"><address><span class="author fn n">Davide Prati</span> - <span class="fn email">lastexxit guess gmail</span></address></li>
						<li class="contact">Sonnenallee 201, Berlin</li>
						<li class="github"><a href="http://github.com/edap/" rel="me">github.com/edap</a></li>
						<li class="rss"><a href="http://feeds.feedburner.com/Edapx">Subscribe to RSS Feed</a></li>
						<li class="rss"><a href="http://edapx.tumblr.com">Tumblr</a></li>
						<li class="rss"><a href="https://plus.google.com/u/0/114627287220738676405/posts">Google Plus</a></li>
					</ul>
				</div><!-- misc -->
				<p class="licence">
					Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a>.
				</p>
			</div><!-- unit-foot-inner -->
		</div><!-- unit-foot -->
	</footer>
</div><!-- page -->
<script>
	(function(d, s) {
		var js, fjs = d.getElementsByTagName(s)[0], load = function(url, id) {
		if (d.getElementById(id)) {return;}
		js = d.createElement(s); js.src = url; js.id = id;
		fjs.parentNode.insertBefore(js, fjs);
		};
	load('//platform.twitter.com/widgets.js', 'tweetjs');
	// load('https://apis.google.com/js/plusone.js', 'gplus1js'); // Checkout http://j.mp/ApDgMr for usage html for this is <div class="g-plusone" data-size="medium"></div>
	// load('//connect.facebook.net/en_US/all.js#xfbml=1', 'fbjssdk'); // Checkout http://j.mp/wZw2xR for using open graph protorol html for this is <div class="fb-like" data-href="/page3/index.html" data-send="false" data-layout="button_count" data-width="450" data-show-faces="false" data-font="verdana"></div>
	}(document, 'script'));
</script>
<script>
/*! A fix for the iOS orientationchange zoom bug.Script by @scottjehl, rebound by @wilto. MIT License.*/
(function(j){var i=j.document;if(!i.querySelectorAll){return}var l=i.querySelectorAll("meta[name=viewport]")[0],a=l&&l.getAttribute("content"),h=a+", maximum-scale=1.0",d=a+", maximum-scale=10.0",g=true,c=j.orientation,k=0;if(!l){return}function f(){l.setAttribute("content",d);g=true}function b(){l.setAttribute("content",h);g=false}function e(m){c=Math.abs(j.orientation);k=Math.abs(m.gamma);if(k>8&&c===0){if(g){b()}}else{if(!g){f()}}}j.addEventListener("orientationchange",f,false);j.addEventListener("deviceorientation",e,false)})(this);
</script>
  
  
</body>
</html>

